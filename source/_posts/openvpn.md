---
title: OpenVPN 学习笔记
date: 2020-01-19 18:38:36
tags: 工具
---

OpenVPN 是一种用来安全地访问网络资源的商业 VPN 。它提供灵活的 VPN 解决方案以确保互联网隐私、远程访问、物联网、云数据中心等领域中数据通信的安全。该方案既可以部署在使用标准服务器的客户端上，也可以部署在虚拟设备或云上。

<!-- more -->

## 什么是 VPN

VPN ，全称 virtual private network，中文译为**虚拟私人网络**，是一种常用于连接中、大型企业或团体与团体间的私人网络的通讯方法。它利用**隧道协议**（Tunneling Protocol）来达到保密、发送端认证、消息准确性等私人消息安全效果，这种技术可以用不安全的网络（例如互联网）来传送可靠、安全的信息。

上面提到的隧道协议是一种网络协议，它将一种网络协议用另一个不同的网络协议进行封装，从而可以在不兼容的网络上传输数据，或者在不安全的网络上提供一个安全路径。Secure Shell（安全外壳协议，简称 SSH）就是一种常见的隧道协议。VPN 的安全性建立在**加密的**隧道协议上。

常用的 VPN 协议有 **L2TP**、**PPTP** 等。其中，L2TP，全称 Layer Two Tunneling Protocol，中文名**第二层隧道协议**，它自身不提供加密与可靠性验证的功能，但它可以和安全协议（或称密码协议）搭配使用，从而实现数据的加密传输。经常与L2TP协议搭配的加密协议是 **IPsec**，当这两个协议搭配使用时，通常合称为 **L2TP/IPsec**。而另一个协议，PPTP，全称 Point to Point Tunneling Protocol，中文名**点对点隧道协议**，其本身同样也不包含加密或身份验证的部分，而是依靠**点对点协议**（PPP）来实现安全性的功能。PPTP 最早由微软等厂商主导开发，但由于其加密方式易被破解，微软已不再建议使用该协议。

由于某些原因，中国大陆境内对海外的网络有限制和屏蔽，因此近年来 VPN 逐渐被用来连接海内外的网络，俗称“翻墙”。2015年1月起，中华人民共和国开始加强对外国 VPN 服务的封锁。2017 年 1 月 22 日，工业和信息化部发布《工业和信息化部关于清理规范互联网网络接入服务市场的通知》，规定未经电信主管部门（各一级行政区通信管理局）批准，不得自行创建或租用 VPN、国际专线等其他信道开展跨境经营活动。而在境内，VPN 属于《商用密码管理条例》，须经国家密码管理局批准。这也意味着在中国大陆的 ISP、IDC 或 CDN 提供商租用或创建 VPN 或国际专线开展业务，必须获取各一级行政区通信管理局的批准。

## 什么是 OpenVPN

OpenVPN 是一个用于创建 VPN 加密通道的软件包，它允许其建立的 VPN 使用公开密钥、电子证书、或者用户名／密码来进行身份验证。目前OpenVPN能在Solaris、Linux、OpenBSD、FreeBSD、NetBSD、Mac OS X 与 Microsoft Windows 以及 Android 和 iOS 上运行，并包含了许多安全性的功能。OpenVPN 与 OpenSSL 库紧密相关，并由此获得许多加密功能。

OpenVPN 的技术核心是**虚拟网卡**。这是一个使用网络底层编程技术实现的驱动软件。安装此类程序后主机上会增加一个非真实的网卡，并可以像其它网卡一样进行配置。服务程序可以在应用层打开虚拟网卡，如果应用软件向虚拟网卡发送数据，则服务程序可以读取到该数据。如果服务程序写合适的数据到虚拟网卡，应用软件也可以接收得到。虚拟网卡在很多的操作系统中都有相应的实现，这也是 OpenVPN 能够跨平台使用的一个重要原因。在 OpenVPN 中，如果用户访问一个远程的虚拟地址（属于虚拟网卡配用的地址系列，区别于真实地址），则操作系统会通过路由机制将数据包或数据帧发送到虚拟网卡上，服务程序接收该数据并进行相应的处理后，会通过 SOCKET 从外网上发送出去。这完成了一个单向传输的过程，反之亦然。当远程服务程序通过 SOCKET 从外网上接收到数据，并进行相应的处理后，又会发送回给虚拟网卡，则该应用软件就可以接收到。

防火长城会针对 OpenVPN 服务器回送证书完成握手创建有效加密连接时干扰连接，在使用 TCP 协议模式时握手会被连接重置，而使用 UDP 协议时含有服务器认证证书的数据包会被故意丢弃，使 OpenVPN 无法创建有效加密连接而连接失败。而在中国大陆内部的连接不受这种限制。

## 如何使用 OpenVPN

OpenVPN 访问服务包括三个部分：OpenVPN 服务、管理员 Web 接口，以及客户端。这里我们只关心客户端。

客户端允许用户通过浏览器直接连接到 VPN，此外，用户还可以下载配置文件以在其他的客户端使用。

下载好客户端后，进入安装目录下的 `config` 文件夹，修改或创建 `password.txt` 文件，第一行填入用于连接的账号，第二行填入密码（二者都是由服务端分配的）。然后再修改 `client.ovpn` 文件，在 `remote` 后面添加 VPN 服务器的 IP 和端口即可完成客户端的配置。

使用时有两种方式，一种是通过官方提供的 GUI，一键式连接。另一种是在命令行调用

```
openvpn --config client.ovpn password.txt
```

或者，如果修改了 `client.ovpn` 文件中的 `auth-user-pass` 字段为 `password.txt` ，亦可直接使用

```
openvpn --config client.ovpn
```
